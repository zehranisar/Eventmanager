{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    .dashboard-container {
        padding: 20px;
        background: #f5f5f5;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #417690;
    }
    
    .stat-card h3 {
        margin: 0 0 10px 0;
        color: #417690;
        font-size: 14px;
        text-transform: uppercase;
        font-weight: 600;
    }
    
    .stat-card .number {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin: 0;
    }
    
    .stat-card.primary { border-left-color: #417690; }
    .stat-card.success { border-left-color: #28a745; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.info { border-left-color: #17a2b8; }
    
    .section {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section h2 {
        margin-top: 0;
        color: #417690;
        border-bottom: 2px solid #417690;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .event-item, .user-item {
        background: #f9f9f9;
        border-left: 3px solid #417690;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    
    .event-item h4, .user-item h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 16px;
    }
    
    .event-item .meta, .user-item .meta {
        color: #666;
        font-size: 13px;
        margin-bottom: 10px;
    }
    
    .registration-count {
        display: inline-block;
        background: #417690;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
        margin-right: 10px;
    }
    
    .registration-count.full {
        background: #dc3545;
    }
    
    .registration-count.low {
        background: #ffc107;
        color: #333;
    }
    
    .registrations-list {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
    }
    
    .registration-item {
        background: white;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        border-left: 2px solid #28a745;
    }
    
    .registration-item .user-name {
        font-weight: 600;
        color: #333;
    }
    
    .registration-item .user-email {
        color: #666;
        font-size: 12px;
    }
    
    .registration-item .details {
        margin-top: 5px;
        font-size: 12px;
        color: #888;
    }
    
    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .badge-success { background: #28a745; color: white; }
    .badge-warning { background: #ffc107; color: #333; }
    .badge-danger { background: #dc3545; color: white; }
    .badge-info { background: #17a2b8; color: white; }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    table th {
        background: #417690;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    
    table td {
        padding: 10px 12px;
        border-bottom: 1px solid #ddd;
    }
    
    table tr:hover {
        background: #f5f5f5;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }
    
    .empty-state::before {
        content: "üìã";
        font-size: 48px;
        display: block;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1 style="color: #417690; margin-bottom: 30px;">üìä Event Manager Dashboard</h1>
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <h3>Total Users</h3>
            <p class="number">{{ total_users }}</p>
        </div>
        <div class="stat-card success">
            <h3>Students</h3>
            <p class="number">{{ total_students }}</p>
        </div>
        <div class="stat-card info">
            <h3>Total Events</h3>
            <p class="number">{{ total_events }}</p>
        </div>
        <div class="stat-card warning">
            <h3>Active Events</h3>
            <p class="number">{{ active_events }}</p>
        </div>
        <div class="stat-card success">
            <h3>Total Registrations</h3>
            <p class="number">{{ total_registrations }}</p>
        </div>
        <div class="stat-card info">
            <h3>Recent (7 days)</h3>
            <p class="number">{{ recent_registrations }}</p>
        </div>
    </div>
    
    <!-- Events with Registration Counts -->
    <div class="section">
        <h2>üìÖ Events & Registration Counts</h2>
        {% if event_registration_details %}
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date & Time</th>
                            <th>Location</th>
                            <th>Registrations</th>
                            <th>Max Participants</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in event_registration_details %}
                        <tr>
                            <td><strong>{{ item.event.title }}</strong></td>
                            <td>{{ item.event.date|date:"M d, Y" }} at {{ item.event.time|time:"g:i A" }}</td>
                            <td>{{ item.event.location }}</td>
                            <td>
                                <span class="registration-count {% if item.is_full %}full{% elif item.count < 5 %}low{% endif %}">
                                    {{ item.count }} registered
                                </span>
                            </td>
                            <td>{{ item.event.max_participants|default:"Unlimited" }}</td>
                            <td>
                                {% if item.is_full %}
                                    <span class="badge badge-danger">Full</span>
                                {% elif item.event.is_active %}
                                    <span class="badge badge-success">Active</span>
                                {% else %}
                                    <span class="badge badge-warning">Inactive</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">No events found</div>
        {% endif %}
    </div>
    
    <!-- Detailed Event Registrations -->
    <div class="section">
        <h2>üë• Event Registration Details</h2>
        {% if event_registration_details %}
            {% for item in event_registration_details %}
                {% if item.count > 0 %}
                <div class="event-item">
                    <h4>
                        <span class="registration-count">{{ item.count }}</span>
                        {{ item.event.title }}
                    </h4>
                    <div class="meta">
                        üìç {{ item.event.location }} | 
                        üìÖ {{ item.event.date|date:"M d, Y" }} at {{ item.event.time|time:"g:i A" }}
                    </div>
                    <div class="registrations-list">
                        <strong>Registered Users:</strong>
                        {% for registration in item.registrations %}
                        <div class="registration-item">
                            <div class="user-name">{{ registration.user.name }}</div>
                            <div class="user-email">üìß {{ registration.user.email }}</div>
                            {% if registration.name or registration.email or registration.phone %}
                            <div class="details">
                                {% if registration.name %}Name: {{ registration.name }}{% endif %}
                                {% if registration.email %} | Email: {{ registration.email }}{% endif %}
                                {% if registration.phone %} | Phone: {{ registration.phone }}{% endif %}
                                {% if registration.student_id %} | Student ID: {{ registration.student_id }}{% endif %}
                            </div>
                            {% endif %}
                            <div class="details" style="margin-top: 5px; color: #999; font-size: 11px;">
                                Registered: {{ registration.registered_at|date:"M d, Y g:i A" }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="empty-state">No registrations found</div>
        {% endif %}
    </div>
    
    <!-- Users with Their Registrations -->
    <div class="section">
        <h2>üë§ Users & Their Event Registrations</h2>
        {% if user_registration_details %}
            {% for item in user_registration_details %}
            <div class="user-item">
                <h4>
                    <span class="registration-count">{{ item.count }}</span>
                    {{ item.user.name }}
                </h4>
                <div class="meta">
                    üìß {{ item.user.email }} | 
                    Role: <span class="badge badge-info">{{ item.user.role|capfirst }}</span>
                </div>
                <div class="registrations-list">
                    <strong>Registered Events:</strong>
                    {% for registration in item.registrations %}
                    <div class="registration-item">
                        <div class="user-name">üéØ {{ registration.event.title }}</div>
                        <div class="meta">
                            üìç {{ registration.event.location }} | 
                            üìÖ {{ registration.event.date|date:"M d, Y" }} at {{ registration.event.time|time:"g:i A" }}
                        </div>
                        {% if registration.name or registration.email or registration.phone %}
                        <div class="details">
                            Registration Details: 
                            {% if registration.name %}{{ registration.name }}{% endif %}
                            {% if registration.email %} | {{ registration.email }}{% endif %}
                            {% if registration.phone %} | {{ registration.phone }}{% endif %}
                            {% if registration.student_id %} | ID: {{ registration.student_id }}{% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">No user registrations found</div>
        {% endif %}
    </div>
    
    <!-- Top Events -->
    {% if top_events %}
    <div class="section">
        <h2>üèÜ Top Events by Registrations</h2>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Event Name</th>
                        <th>Registrations</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in top_events %}
                    <tr>
                        <td><strong>#{{ forloop.counter }}</strong></td>
                        <td>{{ event.title }}</td>
                        <td><span class="registration-count">{{ event.registration_count }}</span></td>
                        <td>{{ event.date|date:"M d, Y" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- Upcoming Events -->
    {% if upcoming_events %}
    <div class="section">
        <h2>üìÜ Upcoming Events (Next 30 Days)</h2>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Event Name</th>
                        <th>Date & Time</th>
                        <th>Location</th>
                        <th>Registrations</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in upcoming_events %}
                    <tr>
                        <td><strong>{{ event.title }}</strong></td>
                        <td>{{ event.date|date:"M d, Y" }} at {{ event.time|time:"g:i A" }}</td>
                        <td>{{ event.location }}</td>
                        <td><span class="registration-count">{{ event.registration_count }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

